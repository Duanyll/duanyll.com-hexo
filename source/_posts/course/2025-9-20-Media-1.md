---
title: 数字媒体技术基础 - 作业 1
tags:
  - 数字媒体
hidden: true
---

![题目和待处理图像](https://img.duanyll.com/img/12c2dd0b.png)

我们就把这张手机拍屏图像作为输入图像，将其转换到 YUV 颜色空间，再以 `4:2:0` 的采样方式保存为 `.yuv` 文件，然后使用 `yuview` 工具查看。

```python
# /// script
# requires-python = ">=3.13"
# dependencies = [
#     "numpy",
#     "pillow",
# ]
# ///
from PIL import Image
import numpy as np

def rgb_to_yuv(image):
    """将 PIL 图像从 RGB 转换为 YUV 颜色空间"""
    rgb = np.array(image).astype(float)
    # RGB 到 YUV 的转换矩阵
    yuv_matrix = np.array([
        [ 0.299,  0.587,  0.114],
        [-0.147, -0.289,  0.436],
        [ 0.615, -0.515, -0.100]
    ])
    yuv = np.dot(rgb, yuv_matrix.T)
    yuv[:, :, 1] += 128  # U 分量偏移
    yuv[:, :, 2] += 128  # V 分量偏移
    return np.clip(yuv, 0, 255).astype(np.uint8)

def downsample_chroma(channel, scale=2):
    """对色度通道进行 2:1 下采样 (4:2:0)"""
    h, w = channel.shape
    new_h, new_w = h // scale, w // scale
    return channel[::scale, ::scale][:new_h, :new_w]

def save_yuv420(image_path, output_path):
    """将图像保存为 YUV 4:2:0 格式"""
    # 打开图像
    img = Image.open(image_path).convert('RGB')
    width, height = img.size

    print(f"Image Size: {width}x{height}")

    # 转换为 YUV
    yuv = rgb_to_yuv(img)
    y, u, v = yuv[:, :, 0], yuv[:, :, 1], yuv[:, :, 2]

    # 对 U 和 V 进行 4:2:0 下采样
    u_down = downsample_chroma(u)
    v_down = downsample_chroma(v)

    # 确保尺寸对齐
    if width % 2 != 0 or height % 2 != 0:
        raise ValueError("图像宽度和高度必须是 2 的倍数以支持 YUV 4:2:0 格式")

    # 保存到 YUV 文件
    with open(output_path, 'wb') as f:
        f.write(y.tobytes())
        f.write(u_down.tobytes())
        f.write(v_down.tobytes())

    print(f"View the file with command:")
    print(f"ffplay -f rawvideo -pixel_format yuv420p -video_size {width}x{height} {output_path}")

if __name__ == "__main__":
    input_image = "input.png"
    output_yuv = "output.yuv"
    save_yuv420(input_image, output_yuv)
```

将上面的代码保存为 `convert_to_yuv420.py`，并确保当前目录下有 `input.png` 图像文件，然后运行：

```bash
uv run convert_to_yuv420.py
```

运行完成后，会生成 `output.yuv` 文件，可以使用 `ffplay` 命令查看：

```bash
ffplay -f rawvideo -pixel_format yuv420p -video_size 708x346 output.yuv
```

![ffplay](https://img.duanyll.com/img/33f98bc0.png)

也可以使用 `yuview` 工具查看, 需要手动输入图像的宽高。

![yuview](https://img.duanyll.com/img/83654a5e.png)
